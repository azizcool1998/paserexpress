server {
    listen 80;
    listen [::]:80;

    server_name a.aziztech.us;

    # === UBAH INI: path ke folder src/public di server ===
    root /var/www/PaserExpress/src/public;
    index index.php;

    access_log /var/log/nginx/PaserExpress.access.log;
    error_log  /var/log/nginx/PaserExpress.error.log;

    # Security headers (basic)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Ukuran upload (kalau nanti butuh upload file)
    client_max_body_size 20m;

    # Cache assets statis
    location ~* \.(?:css|js|jpg|jpeg|png|gif|svg|ico|webp|woff2|woff|ttf)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        try_files $uri =404;
    }

    # Block file sensitif
    location ~ /\.(?!well-known) { deny all; }
    location ~* \.(?:env|ini|log|sql|bak|swp)$ { deny all; }

    # API (opsional): biar /api/... langsung mengarah ke file di src/api
    # Contoh: /api/tracking_mock -> src/api/tracking_mock.php
    location ^~ /api/ {
        # Map /api/foo menjadi /../api/foo.php
        rewrite ^/api/(.+)$ /../api/$1.php last;
    }

    # Routing utama: semua request masuk ke router index.php
    location / {
        try_files $uri /index.php?$query_string;
    }

    # PHP handling
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;

        # Ubuntu 24.04 biasanya pakai php8.3-fpm
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PHP_VALUE "upload_max_filesize=20M \n post_max_size=20M";

        # Hardening
        fastcgi_hide_header X-Powered-By-AzizTech;
    }
}
