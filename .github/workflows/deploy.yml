name: Deploy PaserExpress to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Repository
      uses: actions/checkout@v3

    # ============================================================
    # 1. LOAD SSH PRIVATE KEY (Fixes libcrypto error)
    # ============================================================
    - name: Load Private Key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # ============================================================
    # 2. ADD VPS HOST TO KNOWN HOSTS
    # ============================================================
    - name: Add VPS Host Key
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    # ============================================================
    # 3. TEST SSH CONNECTION
    # ============================================================
    - name: Test SSH Connection
      run: |
        echo "Testing SSH..."
        ssh -o BatchMode=yes -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH OK from GitHub Actions'"
      shell: bash

    # ============================================================
    # 4. RUN DEPLOY SCRIPT IN VPS
    # ============================================================
    - name: Execute Remote Deploy Script
      run: |
        echo "Running remote deploy script..."
        ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "bash /usr/local/bin/paserexpress-deploy.sh"
      shell: bash

    # ============================================================
    # 5. SUCCESS
    # ============================================================
    - name: Deployment Finished
      run: echo "ðŸŽ‰ Deployment Completed Successfully!"
