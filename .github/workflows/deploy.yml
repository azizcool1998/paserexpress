name: ðŸš€ Auto Deploy PaserExpress

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ”„ Checkout Repo
      uses: actions/checkout@v3

    # ============================================
    # 1. SETUP SSH AGENT + LOAD PRIVATE KEY
    # ============================================
    - name: ðŸ” Setup SSH Key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    # ============================================
    # 2. Add VPS to known_hosts
    # ============================================
    - name: ðŸ”‘ Add VPS to known_hosts
      run: |
        ssh-keyscan -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    # ============================================
    # 3. DOWNLOAD DEPLOY SCRIPT FROM GITHUB (REMOTE)
    # ============================================
    - name: ðŸ“¥ Download deploy script from GitHub
      run: |
        ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
        "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/deploy.sh -o /tmp/paserexpress-deploy.sh && chmod +x /tmp/paserexpress-deploy.sh"

    # ============================================
    # 4. EXECUTE DEPLOY SCRIPT
    # ============================================
    - name: ðŸš€ Execute Deploy Script on VPS
      run: |
        ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
        "bash /tmp/paserexpress-deploy.sh"

    # ============================================
    # 5. DONE ðŸŽ‰
    # ============================================
    - name: âœ… Deployment Completed
      run: echo "PaserExpress deployed successfully!"
