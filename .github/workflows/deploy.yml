name: PaserExpress CI/CD Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:

    # ----------------------------------------------------
    # 1) Checkout Repo
    # ----------------------------------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2) Setup SSH Private Key
    # ----------------------------------------------------
    - name: Setup SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.PE_SSH_PRIVATE_KEY }}

    # ----------------------------------------------------
    # 3) Add VPS to known_hosts
    # ----------------------------------------------------
    - name: Add VPS to Known Hosts
      run: |
        ssh-keyscan -p "${{ secrets.PE_SSH_PORT }}" "${{ secrets.PE_SSH_HOST }}" >> ~/.ssh/known_hosts

    # ----------------------------------------------------
    # 4) Deploy to VPS
    # ----------------------------------------------------
    - name: Deploy to VPS via SSH
      run: |
        ssh -p ${{ secrets.PE_SSH_PORT }} ${{ secrets.PE_SSH_USER }}@${{ secrets.PE_SSH_HOST }} "
          set -e

          echo '>>> PaserExpress Deploy Started on VPS'

          # Path aplikasi (sesuaikan jika beda)
          APP_PATH='/var/www/paserexpress'

          # Jika folder belum ada â†’ clone baru
          if [ ! -d \$APP_PATH ]; then
            echo '>>> Creating fresh clone...'
            git clone --depth 1 https://github.com/${{ github.repository }}.git \$APP_PATH
          else
            echo '>>> Updating existing repo...'
            cd \$APP_PATH && git fetch --all && git reset --hard origin/main
          fi

          echo '>>> Setting permissions...'
          chown -R www-data:www-data \$APP_PATH
          find \$APP_PATH -type d -exec chmod 755 {} \;
          find \$APP_PATH -type f -exec chmod 644 {} \;

          # Composer (opsional)
          if [ -f '\$APP_PATH/composer.json' ]; then
            echo '>>> Composer install...'
            cd \$APP_PATH && composer install --no-dev --optimize-autoloader
          fi

          # NodeJS (opsional)
          if [ -f '\$APP_PATH/package.json' ]; then
            echo '>>> Node install/build...'
            cd \$APP_PATH && npm install --omit=dev && npm run build
          fi

          echo '>>> Reloading services...'
          systemctl reload php8.3-fpm || true
          systemctl reload nginx || true

          echo '>>> Deployment complete!'
        "
