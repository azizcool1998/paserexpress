name: ðŸš€ PaserExpress Auto Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    # ================================================================
    #  LOAD SSH KEY DARI GITHUB SECRETS
    # ================================================================
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Add VPS to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    # ================================================================
    #  DEPLOY KE VPS LANGSUNG (TANPA SCRIPT TAMBAHAN)
    # ================================================================
    - name: Deploy to VPS
      run: |
        ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
        
        set -e

        echo '===[1/6] PULL UPDATE DARI GITHUB==='
        cd /var/www/paserexpress || exit 1
        git fetch --all
        git reset --hard origin/main

        echo '===[2/6] SET FILE PERMISSION==='
        chown -R www-data:www-data /var/www/paserexpress
        find /var/www/paserexpress -type d -exec chmod 755 {} \;
        find /var/www/paserexpress -type f -exec chmod 644 {} \;

        echo '===[3/6] RUN BACKUP OTOMATIS==='
        if [ -f /usr/local/bin/paserexpress-backup.sh ]; then
            bash /usr/local/bin/paserexpress-backup.sh
        fi

        echo '===[4/6] RUN AUTO MIGRATION (SKIP IF NONE)==='
        if [ -f /var/www/paserexpress/src/cli/migrate.php ]; then
            php /var/www/paserexpress/src/cli/migrate.php
        fi

        echo '===[5/6] RELOAD PHP-FPM==='
        systemctl reload php8.3-fpm || true

        echo '===[6/6] RESTART NGINX==='
        systemctl reload nginx || true

        echo 'âœ¨ DEPLOY SELESAI TANPA ERROR âœ¨'
        "
