name: Deploy PaserExpress to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    # ============================================================
    # 1. Load SSH Private Key (FIX libcrypto)
    # ============================================================
    - name: Setup SSH Key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # ============================================================
    # 2. Add VPS to known_hosts
    # ============================================================
    - name: Add VPS Key
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    # ============================================================
    # 3. Test SSH Connection
    # ============================================================
    - name: Test SSH
      run: |
        ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo CONNECTED"

    # ============================================================
    # 4. Deploy langsung dari GitHub â†’ VPS
    # ============================================================
    - name: Deploy App to VPS
      run: |
        ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
          set -e

          echo '[1/5] Pull latest code...'
          if [ -d /var/www/paserexpress ]; then
            cd /var/www/paserexpress
            git fetch --all
            git reset --hard origin/main
          else
            git clone -b main https://github.com/${{ github.repository }} /var/www/paserexpress
          fi

          echo '[2/5] Set permissions...'
          chown -R www-data:www-data /var/www/paserexpress
          find /var/www/paserexpress -type d -exec chmod 755 {} \;
          find /var/www/paserexpress -type f -exec chmod 644 {} \;

          echo '[3/5] Reload PHP-FPM...'
          systemctl reload php8.3-fpm || true

          echo '[4/5] Reload Nginx...'
          systemctl reload nginx || true

          echo '[5/5] DEPLOY COMPLETE âœ”'
        "

    # ============================================================
    # 5. Success log
    # ============================================================
    - name: Finish
      run: echo "ðŸš€ Deployment COMPLETED"
